<!DOCTYPE html>
<html>
<head>
  <title>Pharma GPS Dashboard</title>
  <style>
    body { margin: 0; font-family: Arial; background: #f0f0f0; }
    .header { background: #2c3e50; color: white; padding: 20px; text-align: center; }
    .container { display: flex; height: calc(100vh - 100px); gap: 20px; padding: 20px; }
    #map { flex: 2; height: 100%; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); }
    .sidebar { flex: 1; background: white; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); overflow-y: auto; padding: 20px; }
    .vehicle { padding: 15px; margin-bottom: 10px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #3498db; }
    .name { font-weight: bold; font-size: 16px; margin-bottom: 5px; }
    .coords { color: #27ae60; font-family: monospace; font-size: 14px; }
    .status { float: right; padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: bold; }
    .live { background: #d4edda; color: #155724; }
    .offline { background: #f8d7da; color: #721c24; }
  </style>
</head>
<body>
  <div class="header">
    <h1>üöõ Pharma Fleet GPS Tracker</h1>
    <p><strong id="vehicle-count"><%= @vehicles.count %></strong> vehicles ‚Ä¢ Live updates every 10s</p>
  </div>

  <div class="container">
    <div id="map"></div>
    
    <div class="sidebar">
      <% @vehicles.each do |v| %>
        <% last_ping = v.location_points.order(recorded_at: :desc).first %>
        <div class="vehicle" data-vehicle="<%= v.identifier %>">
          <div class="status <%= v.active? ? 'live' : 'offline' %>">
            <%= v.active? ? 'üü¢ LIVE' : 'üî¥ OFFLINE' %>
          </div>
          <div class="name"><%= v.name %> <span style="font-size: 12px;">(<%= v.identifier %>)</span></div>
          <div class="coords" id="coords-<%= v.identifier %>">
            üìç <%= v.current_latitude.round(6) %>, <%= v.current_longitude.round(6) %>
          </div>
          <% if last_ping %>
            <div style="font-size: 12px; color: #666;">
              ‚ö° <%= last_ping.speed.round %> km/h ‚Ä¢ <%= last_ping.recorded_at.strftime('%H:%M:%S') %>
            </div>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Google Maps API - REPLACE YOUR_API_KEY -->
  <script async src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&callback=initMap"></script>
  
  <script>
    let map, markers = {};
    
    function initMap() {
      map = new google.maps.Map(document.getElementById('map'), {
        zoom: 13,
        center: {lat: 37.7749, lng: -122.4194},
        mapTypeId: 'roadmap'
      });
      
      // Initial markers
      <% @vehicles.each do |v| %>
        markers['<%= v.identifier %>'] = new google.maps.Marker({
          position: {lat: <%= v.current_latitude %>, lng: <%= v.current_longitude %>},
          map: map,
          title: '<%= v.name %>',
          label: '<%= v.identifier %>',
          icon: {
            path: google.maps.SymbolPath.CIRCLE,
            scale: 10,
            fillColor: <%= v.active? ? "'#00ff88'" : "'#ff4444'" %>,
            strokeColor: 'white',
            strokeWeight: 2
          }
        });
      <% end %>
    }
    
    // LIVE UPDATES EVERY 10 SECONDS
    setInterval(() => {
      fetch('/vehicles.json')
        .then(r => r.json())
        .then(vehicles => {
          vehicles.forEach(v => {
            if (markers[v.identifier]) {
              markers[v.identifier].setPosition({
                lat: parseFloat(v.current_latitude), 
                lng: parseFloat(v.current_longitude)
              });
              // Update sidebar coords
              const coordEl = document.getElementById('coords-' + v.identifier);
              if (coordEl) {
                coordEl.innerHTML = `üìç ${parseFloat(v.current_latitude).toFixed(6)}, ${parseFloat(v.current_longitude).toFixed(6)}`;
              }
            }
          });
        });
    }, 10000);
  </script>
</body>
</html>
