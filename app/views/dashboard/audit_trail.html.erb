<!DOCTYPE html>
<html>
<head>
  <title>FDA Audit Trail - PharmaTransport</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#0f172a;color:#e2e8f0;padding:20px}
    .header{background:linear-gradient(135deg,#166534,#15803d);padding:24px;border-radius:12px;margin-bottom:24px}
    .header h1{font-size:28px;font-weight:700;display:flex;align-items:center;gap:12px}
    .chain-badge{background:<%= @chain_valid ? '#22c55e' : '#ef4444' %>;padding:6px 16px;border-radius:20px;font-size:14px}
    .compliance-box{background:#1e293b;border:2px solid #166534;border-radius:12px;padding:20px;margin-bottom:24px}
    .compliance-box h2{color:#22c55e;margin-bottom:12px;font-size:18px}
    .compliance-box ul{color:#94a3b8;font-size:14px;line-height:2;padding-left:20px}
    .compliance-box li::marker{color:#22c55e}
    table{width:100%;background:#1e293b;border-radius:12px;border-collapse:collapse;overflow:hidden}
    th,td{padding:14px 16px;text-align:left;border-bottom:1px solid #334155}
    th{background:#0f172a;color:#94a3b8;font-size:11px;text-transform:uppercase;font-weight:600}
    .seq{font-family:monospace;font-weight:700;color:#3b82f6;font-size:16px}
    .action{padding:4px 10px;border-radius:6px;font-size:12px;font-weight:600}
    .action-create{background:#166534;color:#86efac}
    .action-read,.action-list{background:#1e3a5f;color:#93c5fd}
    .action-update{background:#854d0e;color:#fde047}
    .action-delete{background:#991b1b;color:#fecaca}
    .hash{font-family:monospace;font-size:11px;color:#64748b;max-width:140px;overflow:hidden;text-overflow:ellipsis}
    .chain-link{display:flex;align-items:center;gap:4px;font-size:10px;color:#475569;margin-top:4px}
    .nav{margin-bottom:20px}
    .nav a{color:#94a3b8;text-decoration:none;margin-right:20px;padding:8px 0;border-bottom:2px solid transparent}
    .nav a.active{color:#fff;border-color:#22c55e}
    .verify-api{background:#1e293b;padding:16px;border-radius:8px;margin-top:20px;font-family:monospace;font-size:13px;color:#94a3b8}
    .verify-api code{color:#22c55e}
  </style>
</head>
<body>
  <div class="nav">
    <a href="/dashboard">Home</a>
    <a href="/dashboard/shipments">Live Trucks</a>
    <a href="/dashboard/audit_trail" class="active">FDA Audit</a>
  </div>

  <div class="header">
    <h1>
      üîê FDA 21 CFR Part 11 Audit Trail
      <span class="chain-badge"><%= @chain_valid ? '‚úì Chain Valid' : '‚ö† Chain Error' %></span>
    </h1>
    <p style="color:#86efac;margin-top:8px">Immutable Hash-Chained Compliance Logging</p>
  </div>

  <div class="compliance-box">
    <h2>‚úì Regulatory Compliance Features</h2>
    <ul>
      <li><strong>Immutable Records</strong> ‚Äî Audit logs cannot be modified or deleted</li>
      <li><strong>Hash Chain Integrity</strong> ‚Äî SHA-256 linking detects any tampering</li>
      <li><strong>Complete Audit Trail</strong> ‚Äî All API actions logged with actor, IP, timestamp</li>
      <li><strong>Electronic Signatures</strong> ‚Äî API key authentication tracked per request</li>
      <li><strong>Chain Verification API</strong> ‚Äî Cryptographic proof of data integrity</li>
    </ul>
  </div>

  <table>
    <thead>
      <tr>
        <th>Seq #</th>
        <th>Action</th>
        <th>Resource</th>
        <th>Actor</th>
        <th>IP Address</th>
        <th>Hash Chain</th>
        <th>Timestamp</th>
      </tr>
    </thead>
    <tbody>
      <% @audit_logs.each do |log| %>
        <tr>
          <td class="seq">#<%= log.sequence_number %></td>
          <td><span class="action action-<%= log.action %>"><%= log.action.upcase %></span></td>
          <td>
            <strong><%= log.resource_type %></strong>
            <% if log.resource_id %><span style="color:#64748b"> #<%= log.resource_id %></span><% end %>
          </td>
          <td>
            <%= log.actor_type&.titleize || 'System' %>
            <% if log.api_key %><div style="font-size:11px;color:#64748b">Key: <%= log.api_key.prefix %>...</div><% end %>
          </td>
          <td style="font-family:monospace;font-size:12px"><%= log.ip_address || '‚Äî' %></td>
          <td>
            <div class="hash" title="<%= log.record_hash %>"><%= log.record_hash&.first(16) %>...</div>
            <% if log.previous_hash %>
              <div class="chain-link">‚Üê <%= log.previous_hash&.first(12) %>...</div>
            <% else %>
              <div class="chain-link">‚Üê GENESIS</div>
            <% end %>
          </td>
          <td style="font-size:12px;color:#94a3b8"><%= log.created_at.strftime('%Y-%m-%d %H:%M:%S') %></td>
        </tr>
      <% end %>
      <% if @audit_logs.empty? %>
        <tr><td colspan="7" style="text-align:center;padding:40px;color:#64748b">No audit logs yet. API activity will appear here.</td></tr>
      <% end %>
    </tbody>
  </table>

  <div class="verify-api">
    <strong>Verify Chain via API:</strong><br>
    <code>curl -H "X-API-Key: YOUR_KEY" /api/v1/audit_logs/verify</code>
  </div>
</body>
</html>
