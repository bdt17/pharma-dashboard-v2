<!DOCTYPE html>
<html>
<head>
  <title>Live Trucks - PharmaTransport</title>
  <meta http-equiv="refresh" content="30">
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#0f172a;color:#e2e8f0;padding:20px}
    .header{background:linear-gradient(135deg,#1e40af,#7c3aed);padding:24px;border-radius:12px;margin-bottom:24px;display:flex;justify-content:space-between;align-items:center}
    .header h1{font-size:28px;font-weight:700}
    .live-badge{background:#22c55e;color:#fff;padding:6px 16px;border-radius:20px;font-size:14px;font-weight:600;animation:pulse 2s infinite}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.7}}
    .stats{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:24px}
    .stat{background:#1e293b;padding:20px;border-radius:12px;border-left:4px solid #3b82f6}
    .stat.critical{border-color:#ef4444}
    .stat.warning{border-color:#f59e0b}
    .stat.success{border-color:#22c55e}
    .stat h3{color:#94a3b8;font-size:12px;text-transform:uppercase;margin-bottom:8px}
    .stat .value{font-size:36px;font-weight:700}
    .trucks{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:16px}
    .truck{background:#1e293b;border-radius:12px;overflow:hidden}
    .truck-header{padding:16px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #334155}
    .truck-id{font-weight:700;font-size:16px}
    .status{padding:4px 12px;border-radius:20px;font-size:12px;font-weight:600}
    .status-pending{background:#fef3c7;color:#92400e}
    .status-in_transit{background:#3b82f6;color:#fff}
    .status-delivered{background:#22c55e;color:#fff}
    .status-exception{background:#ef4444;color:#fff}
    .truck-body{padding:16px}
    .route{margin-bottom:12px}
    .route-label{color:#64748b;font-size:11px;text-transform:uppercase}
    .route-value{font-size:14px;margin-top:2px}
    .temp-bar{background:#334155;border-radius:8px;height:40px;position:relative;overflow:hidden;margin:12px 0}
    .temp-fill{position:absolute;top:0;left:0;height:100%;border-radius:8px;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:14px;transition:width .5s}
    .temp-ok{background:linear-gradient(90deg,#22c55e,#16a34a)}
    .temp-warn{background:linear-gradient(90deg,#f59e0b,#d97706)}
    .temp-critical{background:linear-gradient(90deg,#ef4444,#dc2626)}
    .compliance{display:flex;gap:8px;margin-top:12px}
    .badge{padding:4px 8px;border-radius:6px;font-size:11px;font-weight:600}
    .badge-ok{background:#166534;color:#86efac}
    .badge-fail{background:#991b1b;color:#fecaca}
    .nav{margin-bottom:20px}
    .nav a{color:#94a3b8;text-decoration:none;margin-right:20px;padding:8px 0;border-bottom:2px solid transparent}
    .nav a.active{color:#fff;border-color:#3b82f6}
    .fda{background:#1e293b;padding:16px;border-radius:12px;margin-top:24px;border:1px solid #334155}
    .fda h3{color:#22c55e;margin-bottom:8px}
  </style>
</head>
<body>
  <div class="nav">
    <a href="/dashboard">Home</a>
    <a href="/dashboard/shipments" class="active">Live Trucks</a>
    <a href="/dashboard/audit_trail">FDA Audit</a>
  </div>

  <div class="header">
    <div>
      <h1>üöõ Live Fleet Tracking</h1>
      <p style="color:#c7d2fe;margin-top:4px">Phase 11.5 ‚Ä¢ Cold Chain Monitoring</p>
    </div>
    <span class="live-badge">‚óè LIVE</span>
  </div>

  <div class="stats">
    <div class="stat success">
      <h3>Active Trucks</h3>
      <div class="value"><%= @shipments.select{|s| s.status == 'in_transit'}.count %></div>
    </div>
    <div class="stat">
      <h3>Total Shipments</h3>
      <div class="value"><%= @shipments.count %></div>
    </div>
    <div class="stat warning">
      <h3>Pending Pickup</h3>
      <div class="value"><%= @shipments.select{|s| s.status == 'pending'}.count %></div>
    </div>
    <div class="stat critical">
      <h3>Temp Excursions</h3>
      <div class="value"><%= @shipments.reject(&:temperature_compliant?).count %></div>
    </div>
  </div>

  <div class="trucks">
    <% @shipments.each do |s| %>
      <div class="truck">
        <div class="truck-header">
          <span class="truck-id"><%= s.tracking_number %></span>
          <span class="status status-<%= s.status %>"><%= s.status&.titleize %></span>
        </div>
        <div class="truck-body">
          <div class="route">
            <div class="route-label">Origin</div>
            <div class="route-value"><%= s.origin_address || '‚Äî' %></div>
          </div>
          <div class="route">
            <div class="route-label">Destination</div>
            <div class="route-value"><%= s.destination_address || '‚Äî' %></div>
          </div>
          <% temp = s.current_temperature || 5.0 %>
          <% temp_pct = [[((temp - s.min_temp) / (s.max_temp - s.min_temp) * 100), 100].min, 5].max %>
          <% temp_class = s.temperature_compliant? ? 'temp-ok' : (temp > s.max_temp + 2 ? 'temp-critical' : 'temp-warn') %>
          <div class="temp-bar">
            <div class="temp-fill <%= temp_class %>" style="width:<%= temp_pct %>%">
              <%= temp.round(1) %>¬∞C (<%= s.min_temp %>‚Äì<%= s.max_temp %>¬∞C)
            </div>
          </div>
          <div class="compliance">
            <% if s.temperature_compliant? %>
              <span class="badge badge-ok">‚úì Compliant</span>
            <% else %>
              <span class="badge badge-fail">‚úó Excursion (<%= s.temperature_events.excursions.count %>)</span>
            <% end %>
            <% if s.alerts.active.any? %>
              <span class="badge badge-fail"><%= s.alerts.active.count %> Alert<%= s.alerts.active.count > 1 ? 's' : '' %></span>
            <% end %>
          </div>
        </div>
      </div>
    <% end %>
    <% if @shipments.empty? %>
      <div style="grid-column:1/-1;text-align:center;padding:60px;color:#64748b">
        No shipments. Use API to create: POST /api/v1/shipments
      </div>
    <% end %>
  </div>

  <div class="fda">
    <h3>‚úì FDA 21 CFR Part 11 Compliant</h3>
    <p style="color:#94a3b8;font-size:14px">All temperature events logged with immutable hash-chain audit trail. <a href="/dashboard/audit_trail" style="color:#3b82f6">View Audit Log ‚Üí</a></p>
  </div>
</body>
</html>
