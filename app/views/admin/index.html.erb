<!DOCTYPE html>
<html>
<head>
  <title>Pharma GPS LIVE</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>
  <h1>ðŸšš Pharma GPS Dashboard - LIVE TRACKING</h1>
  <p>Vehicles: <%= Vehicle.count rescue 0 %></p>
  <div id="map" style="height: 500px; border: 1px solid #ccc;"></div>

  <script>
    var map = L.map('map').setView([33.4484, -112.0740], 10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    
    window.markers = {};
    
    // Load initial vehicles
    fetch('/vehicles').then(r=>r.json()).then(vehicles => {
      vehicles.forEach(v => {
        window.markers[v.id] = L.marker([v.latitude, v.longitude])
          .addTo(map)
          .bindPopup(v.name + ' ðŸ’‰')
          .openPopup();
      });
    });

    // LIVE GPS updates every 10s
    setInterval(() => {
      fetch("/vehicles/update_gps").then(r=>r.json()).then(vehicles => {
        vehicles.forEach(v => {
          if(window.markers[v.id]) {
            window.markers[v.id].setLatLng([v.latitude, v.longitude]);
          }
        });
      });
    }, 10000);
  </script>
</body>
</html>
